<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üöÄ Flashcard Extreme - V2</title>
    <style>
        :root {
            --bg: #f0f4f8; --container-bg: #ffffff; --text-main: #333333;
            --text-sub: #666666; --card-front: #ffffff; --primary: #4A90E2;
            --success: #28a745; --danger: #dc3545; --shadow: rgba(0,0,0,0.05);
            --border: #dddddd; --folder-bg: #f1c40f;
        }
        [data-theme="dark"] {
            --bg: #121212; --container-bg: #1e1e1e; --text-main: #e0e0e0;
            --text-sub: #b0b0b0; --card-front: #2d2d2d; --shadow: rgba(0,0,0,0.3);
            --border: #444444;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text-main); transition: 0.3s; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 600px; margin: auto; }
        .hidden { display: none !important; }

        /* --- FOLDER & DECK ITEMS --- */
        .folder-wrapper { background: var(--container-bg); border-radius: 12px; margin-bottom: 12px; border-left: 8px solid var(--folder-bg); box-shadow: 0 4px 6px var(--shadow); overflow: hidden; }
        .folder-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-weight: bold; }
        .folder-content { padding: 8px; border-top: 1px solid var(--border); background: rgba(0,0,0,0.02); }
        
        .card-item { 
            background: var(--container-bg); padding: 12px 15px; border-radius: 10px; 
            margin-bottom: 8px; display: flex; justify-content: space-between; 
            align-items: center; box-shadow: 0 2px 5px var(--shadow); 
            border-left: 5px solid var(--primary); position: relative;
            user-select: none; /* ‡∏Å‡∏±‡∏ô‡∏Ñ‡∏•‡∏∏‡∏°‡∏î‡∏≥‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ö‡∏¥‡πâ‡∏•‡∏Ñ‡∏•‡∏¥‡∏Å */
        }

        /* --- RANK COLORS --- */
        .rank-2 { color: #5dade2 !important; } .rank-3 { color: #52be80 !important; }
        .rank-5 { color: #f4d03f !important; } .rank-10 { color: #ec7063 !important; }
        .rank-20 { background: linear-gradient(to right, #ff5e5e, #f9d423, #6cfd9f, #6ae9ff, #c392ff, #ff5e5e); background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: rainbow 2s linear infinite; font-weight: bold; }
        @keyframes rainbow { to { background-position: 200% center; } }

        /* --- MODAL / MENU --- */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .modal-content { background: var(--container-bg); padding: 20px; border-radius: 15px; width: 85%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .menu-btn { width: 100%; text-align: left; padding: 15px; margin-bottom: 8px; border-radius: 8px; background: var(--bg); color: var(--text-main); font-size: 16px; border: 1px solid var(--border); font-weight: bold; }
        
        .btn-dots { background: none; color: var(--text-sub); font-size: 20px; padding: 5px 15px; border-radius: 50%; }
        .btn-dots:active { background: rgba(0,0,0,0.1); }
        .theme-switch { position: fixed; top: 15px; right: 15px; background: var(--container-bg); border: 2px solid var(--primary); color: var(--primary); width: 40px; height: 40px; border-radius: 50%; cursor: pointer; z-index: 1000; }
        
        .stats-bar { display: flex; justify-content: space-around; background: var(--container-bg); padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px var(--shadow); }
        .stat-value { display: block; font-size: 24px; font-weight: bold; color: var(--primary); }
        .flashcard { width: 100%; height: 280px; perspective: 1000px; margin-bottom: 20px; }
        .flashcard-inner { position: relative; width: 100%; height: 100%; transition: transform 0.4s; transform-style: preserve-3d; }
        .flashcard.flipped .flashcard-inner { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border-radius: 20px; font-size: 28px; padding: 20px; text-align: center; border: 4px solid var(--container-bg); box-sizing: border-box; }
        .card-back { background: var(--primary); color: white; transform: rotateY(180deg); }
        .btn-main { background: var(--primary); color: white; width: 100%; padding: 15px; border-radius: 10px; margin-bottom: 10px; border: none; font-weight: bold; cursor: pointer; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid var(--border); border-radius: 8px; background: var(--container-bg); color: var(--text-main); box-sizing: border-box; }
    </style>
</head>
<body data-theme="light">

<button class="theme-switch" onclick="toggleTheme()">üåì</button>

<div class="container">
    <h1 style="text-align:center;">üöÄ Flashcard Extreme</h1>

    <div id="view-dashboard">
        <div style="display:flex; gap:10px;">
            <button class="btn-main" style="flex:1" onclick="createFolder()">+ ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
            <button class="btn-main" style="flex:1; background:var(--folder-bg); color:#333" onclick="showCreateDeck()">+ ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</button>
        </div>
        <div id="main-list"></div>
        <p style="text-align:center; font-size:12px; color:var(--text-sub);">üí° ‡∏Å‡∏î 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
    </div>

    <div id="modal-menu" class="modal-overlay hidden" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 id="modal-title" style="margin-top:0">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h3>
            <button class="menu-btn" onclick="startStudyFromMenu()">üìñ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏Å‡∏î‡πÄ‡∏ö‡∏¥‡πâ‡∏•‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏î‡πâ)</button>
            <button class="menu-btn" onclick="editFromMenu()">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πå‡∏î</button>
            <button class="menu-btn" onclick="openMoveMenu()">üì¶ ‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå...</button>
            <button class="menu-btn" style="color:var(--danger)" onclick="deleteFromMenu()">üóëÔ∏è ‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</button>
            <button class="btn-main" style="background:var(--border); color:var(--text-main); margin-top:10px" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>

    <div id="modal-move" class="modal-overlay hidden" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</h3>
            <div id="folder-options" style="max-height: 300px; overflow-y: auto;"></div>
            <button class="btn-main" style="background:var(--border); color:var(--text-main); margin-top:10px" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>

    <div id="view-editor" class="hidden">
        <button onclick="showDashboard()" style="margin-bottom:15px; background:var(--border); padding:8px 15px; border-radius:5px; border:none;">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
        <h2 id="edit-deck-title"></h2>
        <div style="background: var(--container-bg); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px dashed var(--primary);">
            <input type="text" id="new-q" placeholder="‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°">
            <input type="text" id="new-a" placeholder="‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö">
            <button style="background:var(--success); color:white; width:100%; padding:12px; border-radius:8px; border:none; font-weight:bold;" onclick="addCard()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πå‡∏î</button>
        </div>
        <div id="card-list"></div>
    </div>

    <div id="view-study" class="hidden">
        <div class="stats-bar">
            <button onclick="showDashboard()" style="background:var(--border); font-size:12px; padding:5px 10px; border-radius:5px; border:none;">‡∏´‡∏¢‡∏∏‡∏î</button>
            <div class="stat-item" style="text-align:center"><span class="stat-value" id="stat-cards-left">0</span><span style="font-size:10px; color:var(--text-sub)">‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span></div>
            <div class="stat-item" style="text-align:center"><span class="stat-value" id="stat-card-streak">0</span><span style="font-size:10px; color:var(--text-sub)">Streak</span></div>
            <div class="stat-item" style="text-align:center"><span class="stat-value" id="stat-deck-streak">0</span><span style="font-size:10px; color:var(--text-sub)">Perfect</span></div>
        </div>
        <div class="flashcard" id="study-card" onclick="this.classList.toggle('flipped')">
            <div class="flashcard-inner">
                <div class="card-face card-front" id="study-front"></div>
                <div class="card-face card-back" id="study-back"></div>
            </div>
        </div>
        <div style="display:flex; gap:15px;">
            <button style="background:var(--danger); color:white; flex:1; padding:15px; border-radius:10px; border:none; font-weight:bold" onclick="answer(false)">‚ùå ‡∏ú‡∏¥‡∏î</button>
            <button style="background:var(--success); color:white; flex:1; padding:15px; border-radius:10px; border:none; font-weight:bold" onclick="answer(true)">‚úÖ ‡∏ñ‡∏π‡∏Å</button>
        </div>
        <button style="background:#6c757d; color:white; width:100%; margin-top:15px; padding:10px; border-radius:8px; border:none; font-weight:bold" onclick="undo()">‚Ü© Undo</button>
    </div>
</div>

<script>
    // ‡πÉ‡∏ä‡πâ Key ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏µ‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ (v4)
    let appData = JSON.parse(localStorage.getItem('flash_extreme_v4')) || { folders: [], decks: {} };
    let currentDeckId = null, studyQueue = [], failedCards = [], historyStack = [];
    let currentCardStreak = 0, isCurrentRunPerfect = true;
    let activeDeckName = null;

    function save() { localStorage.setItem('flash_extreme_v4', JSON.stringify(appData)); renderDashboard(); }

    function toggleTheme() {
        const t = document.body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        document.body.setAttribute('data-theme', t);
        localStorage.setItem('theme', t);
    }
    if (localStorage.getItem('theme') === 'dark') document.body.setAttribute('data-theme', 'dark');

    function getRankClass(val) {
        if (val >= 20) return 'rank-20'; if (val >= 15) return 'rank-15'; if (val >= 10) return 'rank-10';
        if (val >= 7) return 'rank-7'; if (val >= 5) return 'rank-5'; if (val >= 3) return 'rank-3';
        if (val >= 2) return 'rank-2'; return '';
    }

    // --- RENDER DASHBOARD ---
    function renderDashboard() {
        const list = document.getElementById('main-list');
        list.innerHTML = '';

        // Folders
        appData.folders.forEach((folder, fIdx) => {
            let decksHtml = (folder.decks || []).map(dName => renderDeckItem(dName)).join('');
            list.innerHTML += `
                <div class="folder-wrapper">
                    <div class="folder-header" onclick="toggleFolder(${fIdx})">
                        <span>${folder.isOpen ? 'üìÇ' : 'üìÅ'} ${folder.name}</span>
                        <div onclick="event.stopPropagation()">
                            <button style="font-size:10px; background:var(--border); padding:3px 7px; border-radius:4px; border:none" onclick="renameFolder(${fIdx})">‡πÅ‡∏Å‡πâ</button>
                            <button style="font-size:10px; background:var(--danger); color:white; padding:3px 7px; border-radius:4px; border:none" onclick="deleteFolder(${fIdx})">‡∏•‡∏ö</button>
                        </div>
                    </div>
                    <div class="folder-content ${folder.isOpen ? '' : 'hidden'}">${decksHtml || '<small style="color:#888; padding:10px; display:block">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô</small>'}</div>
                </div>`;
        });

        // Standalone Decks
        const inFolders = appData.folders.flatMap(f => f.decks);
        const standalones = Object.keys(appData.decks).filter(d => !inFolders.includes(d));
        list.innerHTML += `<div style="margin-top:20px;">
            <h3 style="margin-left:5px; font-size:16px; color:var(--text-sub)">üì¶ ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h3>
            ${standalones.map(dName => renderDeckItem(dName)).join('')}
        </div>`;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤ Deck ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö Double Click
    function renderDeckItem(name) {
        const deck = appData.decks[name];
        if (!deck) return '';
        const rank = getRankClass(deck.perfectStreak);
        return `<div class="card-item" ondblclick="startStudy('${name}', true)">
            <div style="flex:1">
                <strong class="${rank}">${name}</strong><br>
                <small style="color:var(--text-sub)">${deck.cards.length} ‡πÉ‡∏ö | üî• Perfect: ${deck.perfectStreak}</small>
            </div>
            <button class="btn-dots" onclick="event.stopPropagation(); openDeckMenu('${name}')">‚ãÆ</button>
        </div>`;
    }

    // --- MODAL SYSTEM ---
    function openDeckMenu(name) {
        activeDeckName = name;
        document.getElementById('modal-title').innerText = name;
        document.getElementById('modal-menu').classList.remove('hidden');
    }

    function closeModal() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.add('hidden')); }
    function startStudyFromMenu() { closeModal(); startStudy(activeDeckName, true); }
    function editFromMenu() { closeModal(); showEditor(activeDeckName); }
    function deleteFromMenu() { if(confirm('‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà?')) { closeModal(); deleteDeck(activeDeckName); } }

    function openMoveMenu() {
        document.getElementById('modal-menu').classList.add('hidden');
        const optCont = document.getElementById('folder-options');
        optCont.innerHTML = `<button class="menu-btn" onclick="moveToFolder(-1)">üì§ ‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå (‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)</button>`;
        appData.folders.forEach((f, i) => {
            optCont.innerHTML += `<button class="menu-btn" onclick="moveToFolder(${i})">üìÅ ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà: ${f.name}</button>`;
        });
        document.getElementById('modal-move').classList.remove('hidden');
    }

    function moveToFolder(fIdx) {
        appData.folders.forEach(f => f.decks = (f.decks || []).filter(d => d !== activeDeckName));
        if (fIdx !== -1) appData.folders[fIdx].decks.push(activeDeckName);
        save(); closeModal();
    }

    // --- CORE LOGIC ---
    function createFolder() { const n = prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå:"); if(n) { appData.folders.push({name:n, decks:[], isOpen:true}); save(); }}
    function toggleFolder(i) { appData.folders[i].isOpen = !appData.folders[i].isOpen; save(); }
    function renameFolder(i) { const n = prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå:", appData.folders[i].name); if(n) { appData.folders[i].name = n; save(); }}
    function deleteFolder(i) { if(confirm('‡∏•‡∏ö‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå? ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏à‡∏∞‡πÄ‡∏î‡πâ‡∏á‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ')) { appData.folders.splice(i, 1); save(); }}
    function showCreateDeck() { const n = prompt("‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:"); if (n && !appData.decks[n]) { appData.decks[n] = { cards: [], perfectStreak: 0 }; save(); } }
    function deleteDeck(n) { delete appData.decks[n]; appData.folders.forEach(f=>f.decks=f.decks.filter(d=>d!==n)); save(); }
    
    function showDashboard() { document.querySelectorAll('.container > div').forEach(d => d.classList.add('hidden')); document.getElementById('view-dashboard').classList.remove('hidden'); renderDashboard(); }
    function showEditor(id) { currentDeckId = id; document.querySelectorAll('.container > div').forEach(d => d.classList.add('hidden')); document.getElementById('view-editor').classList.remove('hidden'); document.getElementById('edit-deck-title').innerText = id; renderCards(); }
    function renderCards() { const list = document.getElementById('card-list'); list.innerHTML = ''; appData.decks[currentDeckId].cards.forEach((c, i) => { list.innerHTML += `<div class="card-item" style="cursor:default"><div style="flex:1"><div contenteditable="true" onblur="updateC(${i},'q',this.innerText)">${c.q}</div><div contenteditable="true" onblur="updateC(${i},'a',this.innerText)" style="color:var(--text-sub)">${c.a}</div></div><button style="background:var(--danger); color:white; padding:5px 10px; border-radius:5px; border:none" onclick="deleteCard(${i})">‡∏•‡∏ö</button></div>`; }); }
    function updateC(i,f,v) { appData.decks[currentDeckId].cards[i][f] = v; save(); }
    function deleteCard(i) { appData.decks[currentDeckId].cards.splice(i, 1); save(); renderCards(); }
    function addCard() { const q = document.getElementById('new-q'), a = document.getElementById('new-a'); if (q.value && a.value) { appData.decks[currentDeckId].cards.push({ q: q.value, a: a.value }); save(); renderCards(); q.value = ''; a.value = ''; q.focus(); } }
    
    function startStudy(id, first) { if (appData.decks[id].cards.length === 0) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πå‡∏î!"); currentDeckId = id; studyQueue = [...appData.decks[id].cards].sort(() => Math.random() - 0.5); failedCards = []; historyStack = []; if (first) isCurrentRunPerfect = true; document.querySelectorAll('.container > div').forEach(d => d.classList.add('hidden')); document.getElementById('view-study').classList.remove('hidden'); nextStudyCard(); }
    function nextStudyCard() { if (studyQueue.length === 0) { if (failedCards.length > 0) { studyQueue = [...failedCards].sort(() => Math.random() - 0.5); failedCards = []; nextStudyCard(); } else { handleAutoRestart(); } return; } document.getElementById('study-card').classList.remove('flipped'); updateStatsUI(); setTimeout(() => { document.getElementById('study-front').innerText = studyQueue[0].q; document.getElementById('study-back').innerText = studyQueue[0].a; }, 150); }
    function answer(correct) { historyStack.push({ queue: [...studyQueue], failed: [...failedCards], streak: currentCardStreak, perfect: appData.decks[currentDeckId].perfectStreak, isPerfect: isCurrentRunPerfect }); const c = studyQueue.shift(); if (correct) { currentCardStreak++; } else { currentCardStreak = 0; isCurrentRunPerfect = false; appData.decks[currentDeckId].perfectStreak = 0; failedCards.push(c); save(); } nextStudyCard(); }
    function undo() { if (!historyStack.length) return; const last = historyStack.pop(); studyQueue = last.queue; failedCards = last.failed; currentCardStreak = last.streak; appData.decks[currentDeckId].perfectStreak = last.perfect; isCurrentRunPerfect = last.isPerfect; save(); nextStudyCard(); }
    function handleAutoRestart() { if (isCurrentRunPerfect) appData.decks[currentDeckId].perfectStreak++; save(); isCurrentRunPerfect = true; studyQueue = [...appData.decks[currentDeckId].cards].sort(() => Math.random() - 0.5); nextStudyCard(); }
    function updateStatsUI() { const perf = appData.decks[currentDeckId].perfectStreak || 0; document.getElementById('stat-cards-left').innerText = studyQueue.length; document.getElementById('stat-card-streak').innerText = currentCardStreak; document.getElementById('stat-deck-streak').innerText = perf; document.getElementById('stat-deck-streak').className = 'stat-value ' + getRankClass(perf); }

    document.getElementById('new-q').addEventListener('keydown', (e) => { if (e.key === 'Enter') document.getElementById('new-a').focus(); });
    document.getElementById('new-a').addEventListener('keydown', (e) => { if (e.key === 'Enter') addCard(); });

    renderDashboard();
</script>
</body>
</html>
